<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page.title }} | Blog Culinaire</title>
    
    <!-- Préchargement des ressources critiques -->
    <link rel="preload" href="{{ '/assets/css/style.css' | relative_url }}" as="style">
    <link rel="preload" href="/images/header.jpg" as="image">
    
    <!-- Préconnexion aux domaines externes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Chargement des styles -->
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="{{ '/assets/css/styles.css' | relative_url }}">
    
    <!-- Fallback pour le chargement des polices si JavaScript est désactivé -->
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    </noscript>
    
    <!-- Chargement différé du widget Netlify Identity -->
    <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <!-- Leaflet CSS et JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Disqus -->
    <script>
      var disqus_config = function () {
        this.page.url = window.location.href;
        this.page.identifier = window.location.pathname;
        this.page.title = document.title;
      };
    </script>
    <script async src="https://appreciationrestaurantssherbrooke.disqus.com/embed.js"></script>
    
    <style>
      /* Styles pour éviter le flash de contenu non stylé */
      .hero {
        min-height: 400px;
        position: relative;
        background-color: #f8f9fa;
      }
    </style>
  </head>
  <body>
    <header class="hero" style="background-image: url('/images/header.jpg');">
      <div class="hero-overlay">
        <h1>Blog Culinaire Sherbrooke</h1>
        <p class="tagline">Nos critiques honnêtes de restaurants à Sherbrooke – pour les amoureux de bonne bouffe</p>
      </div>
      <a href="javascript:void(0)" class="admin-button" id="login-button">
        <i class="fas fa-user"></i>
        <span>Connexion</span>
      </a>
      <div class="login-dropdown" id="login-dropdown">
        <button class="dropdown-item" onclick="handleDisqusLogin()">
          <i class="fas fa-comments"></i>
          <span>Se connecter pour commenter</span>
        </button>
        <button class="dropdown-item" onclick="handleNetlifyLogin()">
          <i class="fas fa-user-shield"></i>
          <span>Administration</span>
        </button>
      </div>
    </header>

    <nav class="main-nav-container">
      <ul>
        <li><a href="{{ '/' | relative_url }}">Accueil</a></li>
        <li><a href="{{ '/about/' | relative_url }}">À propos</a></li>
        <li><a href="{{ '/a-venir/' | relative_url }}">À venir</a></li>
      </ul>
    </nav>

    <main class="container">
      {{ content }}
    </main>

    <footer>
      <div class="footer-content">
        <div class="footer-section">
          <h3><a href="{{ '/about/' | relative_url }}" class="footer-link">À propos de nous</a></h3>
          <p>Deux passionnés de gastronomie qui partagent leurs découvertes culinaires à Sherbrooke.</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>Blog culinaire © 2022-2025 – Fait avec ❤️ par Nataël & Nicolas</p>
      </div>
    </footer>

    <button id="scroll-to-top" class="scroll-to-top">
      <i class="fas fa-arrow-up"></i>
    </button>

    <script>
      // Attendre que le widget Netlify Identity soit chargé
      window.addEventListener('load', function() {
        // Vérifier si le widget est disponible
        if (window.netlifyIdentity) {
          initializeNetlifyIdentity();
        } else {
          // Si le widget n'est pas disponible, réessayer après un court délai
          setTimeout(function() {
            if (window.netlifyIdentity) {
              initializeNetlifyIdentity();
            } else {
              console.error('Netlify Identity widget not loaded');
            }
          }, 1000);
        }
      });

      function initializeNetlifyIdentity() {
        const loginButton = document.getElementById('login-button');
        const loginDropdown = document.getElementById('login-dropdown');
        
        // Fonction pour gérer le clic sur le bouton
        function handleLoginClick(e) {
          e.preventDefault();
          e.stopPropagation();
          loginDropdown.classList.toggle('show');
        }

        // Fermer le dropdown si on clique en dehors
        document.addEventListener('click', function(e) {
          if (!loginButton.contains(e.target) && !loginDropdown.contains(e.target)) {
            loginDropdown.classList.remove('show');
          }
        });

        // Initialisation du bouton
        loginButton.addEventListener('click', handleLoginClick);

        // Vérifier l'état de connexion au chargement de la page
        const user = window.netlifyIdentity.currentUser();
        updateButtonState(user);

        window.netlifyIdentity.on("init", user => {
          updateButtonState(user);
        });

        window.netlifyIdentity.on("login", user => {
          updateButtonState(user);
          // Redirection vers la page admin après la connexion
          window.location.href = '/admin/';
        });

        window.netlifyIdentity.on("logout", () => {
          updateButtonState(null);
        });

        // Fonction pour mettre à jour l'état du bouton
        function updateButtonState(user) {
          if (user) {
            loginButton.innerHTML = '<i class="fas fa-user"></i><span>Admin</span>';
            loginButton.onclick = () => window.location.href = '/admin/';
            loginDropdown.style.display = 'none';
          } else {
            loginButton.innerHTML = '<i class="fas fa-user"></i><span>Connexion</span>';
            loginButton.onclick = handleLoginClick;
            loginDropdown.style.display = 'block';
          }
        }
      }

      // Fonction pour gérer la connexion Disqus
      function handleDisqusLogin() {
        // Vérifier si Disqus est chargé
        if (typeof DISQUS !== 'undefined') {
          DISQUS.reset({
            reload: true
          });
        } else {
          // Si Disqus n'est pas chargé, recharger la page pour forcer le chargement
          window.location.reload();
        }
        document.getElementById('login-dropdown').classList.remove('show');
      }

      // Fonction pour gérer la connexion Netlify
      function handleNetlifyLogin() {
        if (window.netlifyIdentity) {
          window.netlifyIdentity.open('login');
        } else {
          console.error('Netlify Identity widget not loaded');
        }
        document.getElementById('login-dropdown').classList.remove('show');
      }

      // Initialisation du menu déroulant même si Netlify Identity n'est pas chargé
      document.addEventListener('DOMContentLoaded', function() {
        const loginButton = document.getElementById('login-button');
        const loginDropdown = document.getElementById('login-dropdown');
        
        // Fonction pour gérer le clic sur le bouton
        function handleLoginClick(e) {
          e.preventDefault();
          e.stopPropagation();
          loginDropdown.classList.toggle('show');
        }

        // Fermer le dropdown si on clique en dehors
        document.addEventListener('click', function(e) {
          if (!loginButton.contains(e.target) && !loginDropdown.contains(e.target)) {
            loginDropdown.classList.remove('show');
          }
        });

        // Initialisation du bouton
        loginButton.addEventListener('click', handleLoginClick);
      });

      // Optimisation du scroll to top avec throttling
      let scrollTimeout;
      const scrollToTopButton = document.getElementById('scroll-to-top');
      
      window.addEventListener('scroll', () => {
        if (!scrollTimeout) {
          scrollTimeout = setTimeout(() => {
            if (window.pageYOffset > 300) {
              scrollToTopButton.classList.add('show');
              // Vérifier si on est en bas de la page
              const isBottom = window.innerHeight + window.pageYOffset >= document.documentElement.scrollHeight - 100;
              if (isBottom) {
                scrollToTopButton.classList.add('bottom-page');
              } else {
                scrollToTopButton.classList.remove('bottom-page');
              }
            } else {
              scrollToTopButton.classList.remove('show');
              scrollToTopButton.classList.remove('bottom-page');
            }
            scrollTimeout = null;
          }, 100);
        }
      });

      scrollToTopButton.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    </script>
  </body>
</html>
